<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <title>CEP PRO | Controle Estatístico Avançado</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bibliotecas Externas (CDNs Estáveis) -->
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js" charset="utf-8"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
  <!-- jStat para funções de distribuição probabilística -->
  <script src="https://cdn.jsdelivr.net/npm/jstat@latest/dist/jstat.min.js"></script>

  <!-- IBM Plex Sans (Tipografia Moderna) -->
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/layout.css">
</head>
<body>

<!-- UI Main -->
<header class="header">
  <div class="header-left">
    <button class="toggle-btn" id="toggle-sidebar" title="Menu Principal"><span class="material-icons">menu</span></button>
    <div class="brand">
      <span class="material-icons" style="color:var(--col-primary)">query_stats</span>
      <div style="display:flex; flex-direction:column; line-height:1;">
        <span>CEP PRO</span>
        <span class="version-tag">V1.3 UI REFRESH</span>
      </div>
    </div>
  </div>

  <div class="header-right">
    <div class="kpi-deck">
      <button class="alert-pill" id="alert-pill" style="display:none" onclick="App.scrollToLog()">
        <span class="material-icons" style="font-size:18px">notifications_active</span>
        <span id="alert-count" style="margin-left:4px;">0</span>
      </button>
      <div id="kpi-container" style="display:flex; gap:24px; align-items:center;"></div>
    </div>
    <button class="toggle-btn" id="toggle-panel" title="Painel de Detalhes"><span class="material-icons">space_dashboard</span></button>
  </div>
</header>

<aside class="sidebar">
  <div class="sidebar-group">
    <div class="group-title">Fonte de Dados</div>
    <button class="btn btn-primary" onclick="document.getElementById('file-input').click()">
      <span class="material-icons">folder_open</span> Importar Arquivo
    </button>
    <input type="file" id="file-input" accept=".csv,.xlsx" style="display:none">
    <div id="file-info" style="font-size:0.75rem; color:var(--col-muted); display:flex; align-items:center; gap:6px;">
      <span class="material-icons" style="font-size:14px">info</span> Nenhum arquivo carregado
    </div>
  </div>

  <div class="sidebar-group">
    <div class="group-title">Parâmetros de Análise</div>
    <label>Variável de Controle</label>
    <select id="col-select"><option value="">Selecione a Coluna...</option></select>

    <label style="margin-top:8px;">Fator de Estratificação (Opcional)</label>
    <select id="col-strat"><option value="">Nenhuma</option></select>

    <label style="margin-top:8px;">Tamanho do Subgrupo (n)</label>
    <input type="number" id="inp-n" value="5" min="2" max="15">

    <label style="margin-top:8px;">Estimativa de Sigma</label>
    <select id="sel-method">
      <option value="rbar">R-Bar (Amplitude)</option>
      <option value="sbar">S-Bar (Desvio Padrão)</option>
    </select>

    <label style="display:flex; align-items:center; gap:8px; margin-top:12px; cursor:pointer;">
      <input type="checkbox" id="chk-iqr">
      <span>Filtrar Outliers (IQR)</span>
    </label>
  </div>

  <div class="sidebar-group">
    <div class="group-title">Limites de Especificação</div>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
      <div>
        <label>LIE (Mín)</label>
        <input type="number" id="inp-lsl" placeholder="-">
      </div>
      <div>
        <label>LSE (Máx)</label>
        <input type="number" id="inp-usl" placeholder="-">
      </div>
    </div>
  </div>

  <div class="sidebar-group">
    <div class="group-title">Regras de Controle</div>
    <div class="rule-list">
      <label><input type="checkbox" id="r1" checked> 1. Pontos Fora dos Limites (3σ)</label>
      <label><input type="checkbox" id="r2" checked> 2. 9 Pontos Consecutivos (Mesmo Lado)</label>
      <label><input type="checkbox" id="r3" checked> 3. 2 de 3 Pontos > 2σ</label>
      <label><input type="checkbox" id="r4" checked> 4. 4 de 5 Pontos > 1σ</label>
      <label><input type="checkbox" id="r5" checked> 5. Tendência (6 Pontos)</label>
    </div>
  </div>

  <div class="sidebar-group">
    <div class="group-title">Relatórios & Exportação</div>
    <div class="btn-mini-group">
      <button class="btn btn-secondary btn-mini" onclick="App.exportCSV('series')">CSV Dados</button>
      <button class="btn btn-secondary btn-mini" onclick="App.exportCSV('events')">CSV Logs</button>
    </div>
    <button class="btn btn-secondary" style="margin-top:8px;" onclick="App.exportXLSX()">
      <span class="material-icons">table_view</span> Relatório Excel
    </button>
  </div>

  <div style="margin-top: auto; border-top: 1px solid var(--border-color); padding-top: 20px;">
    <span style="font-size: 0.75rem; color: var(--col-muted); display:block; margin-bottom:4px;">Desenvolvido por</span>
    <a href="https://www.linkedin.com/in/thiago-terto-eng-qu%C3%ADmico/" target="_blank" style="display: flex; align-items: center; gap: 8px; text-decoration: none; color: var(--col-primary); font-weight: 600; transition: color 0.2s; font-size: 0.9rem;">
      <span class="material-icons" style="font-size: 18px;">link</span>
      Thiago Terto
    </a>
  </div>
</aside>

<section class="stage">
  <div id="loader"><div class="spinner"></div><div style="margin-top:16px; font-weight:500; color:var(--col-muted);">Processando dados...</div></div>

  <div class="toolbar">
    <div class="toolbar-lbl">Zoom & Janela</div>
    <select id="sel-window" style="width:auto; padding-right:32px; border:1px solid var(--border-color); background:#FFF;">
      <option value="0">Visualizar Tudo</option>
      <option value="50">Últimos 50 Pontos</option>
      <option value="100">Últimos 100 Pontos</option>
      <option value="200">Últimos 200 Pontos</option>
    </select>
    <input type="range" id="rng-window" min="0" value="0" style="flex:1;">
    <div class="toolbar-lbl" id="lbl-window" style="min-width:100px; text-align:right;">Total: 0</div>
  </div>

  <div class="tab-nav">
    <button class="tab-btn active" data-tab="t-imr">I-MR</button>
    <button class="tab-btn" data-tab="t-xbar">X-Bar R</button>
    <button class="tab-btn" data-tab="t-xbars">X-Bar S</button>
    <button class="tab-btn" data-tab="t-six">Sixpack</button>
    <button class="tab-btn" data-tab="t-run">Run Chart</button>
    <button class="tab-btn" data-tab="t-adv">Avançado</button>
  </div>

  <div id="t-imr" class="tab-pane active">
    <div class="chart-container">
      <div class="chart-header">Carta I (Valores Individuais)</div>
      <button class="chart-action" onclick="App.expandChart('ind')" title="Expandir"><span class="material-icons" style="font-size:20px">fullscreen</span></button>
      <div id="plt-ind" class="plot-div"></div>
    </div>
    <div class="chart-container">
      <div class="chart-header">Carta MR (Amplitude Móvel)</div>
      <button class="chart-action" onclick="App.expandChart('mr')" title="Expandir"><span class="material-icons" style="font-size:20px">fullscreen</span></button>
      <div id="plt-mr" class="plot-div"></div>
    </div>
  </div>

  <div id="t-xbar" class="tab-pane">
    <div class="chart-container">
      <div class="chart-header">Carta X-Bar (Médias do Subgrupo)</div>
      <button class="chart-action" onclick="App.expandChart('xbar')" title="Expandir"><span class="material-icons" style="font-size:20px">fullscreen</span></button>
      <div id="plt-xbar" class="plot-div"></div>
    </div>
    <div class="chart-container">
      <div class="chart-header">Carta R (Amplitude do Subgrupo)</div>
      <button class="chart-action" onclick="App.expandChart('r')" title="Expandir"><span class="material-icons" style="font-size:20px">fullscreen</span></button>
      <div id="plt-r" class="plot-div"></div>
    </div>
  </div>

  <div id="t-xbars" class="tab-pane">
    <div class="chart-container">
      <div class="chart-header">Carta X-Bar (Médias do Subgrupo)</div>
      <button class="chart-action" onclick="App.expandChart('xbars')" title="Expandir"><span class="material-icons" style="font-size:20px">fullscreen</span></button>
      <div id="plt-xbars" class="plot-div"></div>
    </div>
    <div class="chart-container">
      <div class="chart-header">Carta S (Desvio Padrão do Subgrupo)</div>
      <button class="chart-action" onclick="App.expandChart('s')" title="Expandir"><span class="material-icons" style="font-size:20px">fullscreen</span></button>
      <div id="plt-s" class="plot-div"></div>
    </div>
  </div>

  <div id="t-six" class="tab-pane">
    <div class="sixpack-grid">
      <div class="sixpack-cell"><div class="chart-header">1. Carta I (Indiv.)</div><div id="six-1" class="plot-div"></div></div>
      <div class="sixpack-cell"><div class="chart-header">2. Histograma Capabilidade</div><div id="six-2" class="plot-div"></div></div>
      <div class="sixpack-cell"><div class="chart-header">3. Carta MR (Ampl.)</div><div id="six-3" class="plot-div"></div></div>
      <div class="sixpack-cell"><div class="chart-header">4. Probabilidade Normal</div><div id="six-4" class="plot-div"></div></div>
      <div class="sixpack-cell"><div class="chart-header">5. Últimos 25</div><div id="six-5" class="plot-div"></div></div>
      <div class="sixpack-cell"><div class="chart-header">6. Plot Capabilidade</div><div id="six-6" class="plot-div"></div></div>
    </div>
  </div>

  <div id="t-run" class="tab-pane">
    <div class="chart-container" style="flex:2;">
      <div class="chart-header">Gráfico de Corridas (Run Chart)</div>
      <button class="chart-action" onclick="App.expandChart('run')" title="Expandir"><span class="material-icons" style="font-size:20px">fullscreen</span></button>
      <div id="plt-run" class="plot-div"></div>
    </div>
    <div class="chart-container" style="flex:1; overflow-y:auto; padding:20px;">
      <div class="chart-header">Estatísticas do Teste de Corridas</div>
      <div id="run-stats" style="margin-top:24px;"></div>
    </div>
  </div>

  <div id="t-adv" class="tab-pane">
    <div class="chart-container">
      <div class="chart-header">CUSUM (Soma Acumulada)</div>
      <div id="plt-cusum" class="plot-div"></div>
    </div>
    <div class="chart-container">
      <div class="chart-header">EWMA (Média Móvel Exponencial)</div>
      <div id="plt-ewma" class="plot-div"></div>
    </div>
  </div>
</section>

<aside class="panel">
  <div class="panel-section">
    <div class="panel-title"><span class="material-icons" style="font-size:16px;">calculate</span> Estatística Descritiva</div>
    <div class="stats-grid" id="stats-grid">
      <div style="color:var(--col-muted); text-align:center; grid-column:span 2; font-style:italic; padding:20px;">
        Aguardando carregamento de dados...
      </div>
    </div>
  </div>

  <div class="panel-section" style="background:#FAFAFA;">
    <div class="panel-title"><span class="material-icons" style="font-size:16px;">handyman</span> Ferramentas</div>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom: 8px;">
      <button class="btn btn-secondary" style="justify-content:center;" onclick="App.openModal('pareto')">
        <span class="material-icons" style="font-size:18px;">bar_chart</span> Pareto
      </button>
      <button class="btn btn-secondary" style="justify-content:center;" onclick="App.openModal('box')">
        <span class="material-icons" style="font-size:18px;">candlestick_chart</span> Boxplot
      </button>
      <button class="btn btn-action" style="grid-column: span 2; justify-content:center;" onclick="App.openModal('insights')">
        <span class="material-icons" style="font-size:18px;">lightbulb</span> Analisar Processo
      </button>
    </div>
  </div>

  <div class="panel-section" style="border-bottom:none; padding-bottom:4px;">
    <div class="panel-title"><span class="material-icons" style="font-size:16px;">history</span> Diário de Eventos</div>
  </div>
  <div class="log-list" id="log-list"></div>
</aside>

<!-- Modal Charts/Insights -->
<div class="modal-overlay" id="modal-chart">
  <div class="modal-box">
    <div class="modal-header">
      <h3 class="modal-title" id="modal-title">Visualização</h3>
      <button class="modal-close" onclick="App.closeModal('modal-chart')"><span class="material-icons">close</span></button>
    </div>
    <div id="modal-body" class="modal-body"></div>
  </div>
</div>

<!-- Modal Notes -->
<div class="modal-overlay" id="modal-note">
  <div class="modal-box small">
    <h3 style="margin:0 0 16px 0; font-weight:600; color:var(--col-primary);">Registro de Ocorrência</h3>
    <div style="background:#F4F4F4; padding:12px; border-radius:4px; font-size:0.85rem; border:1px solid #EEE;" id="note-context"></div>

    <div>
      <label>Causa Raiz</label>
      <textarea id="note-cause" rows="3" style="width:100%; border:1px solid var(--border-color); padding:10px; font-family:inherit; border-radius:0;"></textarea>
    </div>

    <div>
      <label>Ação Corretiva</label>
      <textarea id="note-action" rows="3" style="width:100%; border:1px solid var(--border-color); padding:10px; font-family:inherit; border-radius:0;"></textarea>
    </div>

    <div style="display:flex; justify-content:flex-end; gap:12px; margin-top:8px;">
      <button class="btn btn-secondary" style="width:auto;" onclick="App.closeModal('modal-note')">Cancelar</button>
      <button class="btn btn-primary" style="width:auto;" onclick="App.saveNote()">Salvar Registro</button>
    </div>
  </div>
</div>

<script type="module" src="js/main.js"></script>

</body>
</html>
